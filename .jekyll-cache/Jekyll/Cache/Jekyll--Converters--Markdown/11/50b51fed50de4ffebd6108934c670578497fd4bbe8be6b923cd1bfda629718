I"hø<h2 id="å‰è¨€">å‰è¨€</h2>

<p>ä»Šå¤©æˆ‘ä»¬æ¥æ”¾æ¾ä¸‹å¿ƒæƒ…ï¼Œä¸èŠåˆ†å¸ƒå¼ï¼Œäº‘åŸç”Ÿï¼Œæ¥èŠä¸€èŠåˆå­¦è€…æ¥è§¦çš„æœ€å¤šçš„ java web åŸºç¡€ã€‚å‡ ä¹æ‰€æœ‰äººéƒ½æ˜¯ä» servletï¼Œjspï¼Œfilter å¼€å§‹ç¼–å†™è‡ªå·±çš„ç¬¬ä¸€ä¸ª hello world å·¥ç¨‹ã€‚é‚£æ—¶ï¼Œè¿˜ç¦»ä¸å¼€ web.xml çš„é…ç½®ï¼Œåœ¨ xml æ–‡ä»¶ä¸­ç¼–å†™ç¹ççš„ servlet å’Œ filter çš„é…ç½®ã€‚éšç€ spring çš„æ™®åŠï¼Œé…ç½®é€æ¸æ¼”å˜æˆäº†ä¸¤ç§æ–¹å¼â€”java configuration å’Œ xml é…ç½®å…±å­˜ã€‚ç°å¦‚ä»Šï¼Œspringboot çš„æ™®åŠï¼Œjava configuration æˆäº†ä¸»æµï¼Œxml é…ç½®ä¼¼ä¹å·²ç»â€œç­ç»â€äº†ã€‚ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å¥½å¥‡è¿‡ï¼Œè¿™ä¸­é—´éƒ½å‘ç”Ÿäº†å“ªäº›æ”¹å˜ï¼Œweb.xml ä¸­çš„é…ç½®é¡¹åˆæ˜¯è¢«ä»€ä¹ˆæ›¿ä»£é¡¹å–ä»£äº†ï¼Ÿ</p>

<p><img src="http://kirito.iocoder.cn/servlet.png" alt="java" /></p>

<h2 id="servlet30-ä»¥å‰çš„æ—¶ä»£">servlet3.0 ä»¥å‰çš„æ—¶ä»£</h2>

<p>ä¸ºäº†ä½“ç°å‡ºæ•´ä¸ªæ¼”è¿›è¿‡ç¨‹ï¼Œè¿˜æ˜¯æ¥å›é¡¾ä¸‹ n å¹´å‰æˆ‘ä»¬æ˜¯æ€ä¹ˆå†™ servlet å’Œ filter ä»£ç çš„ã€‚</p>

<p>é¡¹ç›®ç»“æ„ï¼ˆæœ¬æ–‡éƒ½é‡‡ç”¨ maven é¡¹ç›®ç»“æ„ï¼‰</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># servlet2.xæ—¶ä»£ç›®å½•ç»“æ„</span>
<span class="nb">.</span>
â”œâ”€â”€ pom.xml
â”œâ”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ moe
    â”‚   â”‚       â””â”€â”€ cnkirito
    â”‚   â”‚           â”œâ”€â”€ filter
    â”‚   â”‚           â”‚   â””â”€â”€ HelloWorldFilter.java
    â”‚   â”‚           â””â”€â”€ servlet
    â”‚   â”‚               â””â”€â”€ HelloWorldServlet.java
    â”‚   â””â”€â”€ resources
    â”‚       â””â”€â”€ WEB-INF
    â”‚           â””â”€â”€ web.xml
    â””â”€â”€ <span class="nb">test</span>
        â””â”€â”€ java

</code></pre></div></div>
<blockquote>
  <p>HelloWorldServlet.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/plain"</span><span class="o">);</span>
        <span class="nc">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello world"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<blockquote>
  <p>HelloWorldFilter.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">servletRequest</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">servletResponse</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è§¦å‘ hello world è¿‡æ»¤å™¨..."</span><span class="o">);</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">,</span><span class="n">servletResponse</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åˆ«å¿˜äº†åœ¨ web.xml ä¸­é…ç½® servlet å’Œ filter</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/javaee"</span>
           <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
           <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/javaee
        http://java.sun.com/xml/ns/javaee/web-app_4_0.xsd"</span>
           <span class="na">version=</span><span class="s">"4.0"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>HelloWorldServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>moe.cnkirito.servlet.HelloWorldServlet<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>

    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>HelloWorldServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/hello<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>HelloWorldFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>moe.cnkirito.filter.HelloWorldFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>HelloWorldFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/hello<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

<span class="nt">&lt;/web-app&gt;</span>

</code></pre></div></div>
<p>è¿™æ ·ï¼Œä¸€ä¸ª java web hello world å°±å®Œæˆäº†ã€‚å½“ç„¶ï¼Œæœ¬æ–‡ä¸æ˜¯ servlet çš„å…¥é—¨æ•™ç¨‹ï¼Œåªæ˜¯ä¸ºäº†å¯¹æ¯”ã€‚</p>

<h2 id="servlet30-æ–°ç‰¹æ€§">servlet3.0 æ–°ç‰¹æ€§</h2>

<p><img src="http://kirito.iocoder.cn/servlet_3.0.jpg" alt="servlet_3.0" /></p>

<p>Servlet 3.0 ä½œä¸º Java EE 6 è§„èŒƒä½“ç³»ä¸­ä¸€å‘˜ï¼Œéšç€ Java EE 6 è§„èŒƒä¸€èµ·å‘å¸ƒã€‚è¯¥ç‰ˆæœ¬åœ¨å‰ä¸€ç‰ˆæœ¬ï¼ˆServlet 2.5ï¼‰çš„åŸºç¡€ä¸Šæä¾›äº†è‹¥å¹²æ–°ç‰¹æ€§ç”¨äºç®€åŒ– Web åº”ç”¨çš„å¼€å‘å’Œéƒ¨ç½²ã€‚å…¶ä¸­ä¸€é¡¹æ–°ç‰¹æ€§ä¾¿æ˜¯æä¾›äº†æ—  xml é…ç½®çš„ç‰¹æ€§ã€‚</p>

<p>servlet3.0 é¦–å…ˆæä¾›äº† @WebServletï¼Œ@WebFilter ç­‰æ³¨è§£ï¼Œè¿™æ ·ä¾¿æœ‰äº†æŠ›å¼ƒ web.xml çš„ç¬¬ä¸€ä¸ªé€”å¾„ï¼Œå‡­å€Ÿæ³¨è§£å£°æ˜ servlet å’Œ filter æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>

<p>é™¤äº†è¿™ç§æ–¹å¼ï¼Œservlet3.0 è§„èŒƒè¿˜æä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œ servlet ï¼Œfilterï¼Œlistenerã€‚ä»¥ servlet ä¸ºä¾‹ï¼Œè¿‡æ»¤å™¨ä¸ç›‘å¬å™¨ä¸ä¹‹ç±»ä¼¼ã€‚ServletContext ä¸ºåŠ¨æ€é…ç½® Servlet å¢åŠ äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>ServletRegistration.Dynamic addServlet(String servletName,Class&lt;? extends Servlet&gt; servletClass)</li>
  <li>ServletRegistration.Dynamic addServlet(String servletName, Servlet servlet)</li>
  <li>ServletRegistration.Dynamic addServlet(String servletName, String className)</li>
  <li>T createServlet(Class clazz)</li>
  <li>ServletRegistration getServletRegistration(String servletName)</li>
  <li>Map&lt;String,? extends ServletRegistration&gt; getServletRegistrations()</li>
</ul>

<p>å…¶ä¸­å‰ä¸‰ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯å‚æ•°ç±»å‹ä¸åŒè€Œå·²ï¼›é€šè¿‡ createServlet() æ–¹æ³•åˆ›å»ºçš„ Servletï¼Œé€šå¸¸éœ€è¦åšä¸€äº›è‡ªå®šä¹‰çš„é…ç½®ï¼Œç„¶åä½¿ç”¨ addServlet() æ–¹æ³•æ¥å°†å…¶åŠ¨æ€æ³¨å†Œä¸ºä¸€ä¸ªå¯ä»¥ç”¨äºæœåŠ¡çš„ Servletã€‚ä¸¤ä¸ª getServletRegistration() æ–¹æ³•ä¸»è¦ç”¨äºåŠ¨æ€ä¸º Servlet å¢åŠ æ˜ å°„ä¿¡æ¯ï¼Œè¿™ç­‰ä»·äºåœ¨ web.xml ä¸­ä½¿ç”¨ æ ‡ç­¾ä¸ºå­˜åœ¨çš„ Servlet å¢åŠ æ˜ å°„ä¿¡æ¯ã€‚</p>

<p>ä»¥ä¸Š ServletContext æ–°å¢çš„æ–¹æ³•è¦ä¹ˆæ˜¯åœ¨ ServletContextListener çš„ contexInitialized æ–¹æ³•ä¸­è°ƒç”¨ï¼Œè¦ä¹ˆæ˜¯åœ¨ ServletContainerInitializer çš„ onStartup() æ–¹æ³•ä¸­è°ƒç”¨ã€‚</p>

<p>ServletContainerInitializer ä¹Ÿæ˜¯ Servlet 3.0 æ–°å¢çš„ä¸€ä¸ªæ¥å£ï¼Œå®¹å™¨åœ¨å¯åŠ¨æ—¶ä½¿ç”¨ JAR æœåŠ¡ API(JAR Service API) æ¥å‘ç° ServletContainerInitializer çš„å®ç°ç±»ï¼Œå¹¶ä¸”å®¹å™¨å°† WEB-INF/lib ç›®å½•ä¸‹ JAR åŒ…ä¸­çš„ç±»éƒ½äº¤ç»™è¯¥ç±»çš„ onStartup() æ–¹æ³•å¤„ç†ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦åœ¨è¯¥å®ç°ç±»ä¸Šä½¿ç”¨ @HandlesTypes æ³¨è§£æ¥æŒ‡å®šå¸Œæœ›è¢«å¤„ç†çš„ç±»ï¼Œè¿‡æ»¤æ‰ä¸å¸Œæœ›ç»™ onStartup() å¤„ç†çš„ç±»ã€‚</p>

<p>ä¸€ä¸ªå…¸å‹çš„ servlet3.0+ çš„ web é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
â”œâ”€â”€ pom.xml
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ moe
    â”‚   â”‚       â””â”€â”€ cnkirito
    â”‚   â”‚           â”œâ”€â”€ CustomServletContainerInitializer.java
    â”‚   â”‚           â”œâ”€â”€ filter
    â”‚   â”‚           â”‚   â””â”€â”€ HelloWorldFilter.java
    â”‚   â”‚           â””â”€â”€ servlet
    â”‚   â”‚               â””â”€â”€ HelloWorldServlet.java
    â”‚   â””â”€â”€ resources
    â”‚       â””â”€â”€ META-INF
    â”‚           â””â”€â”€ services
    â”‚               â””â”€â”€ javax.servlet.ServletContainerInitializer
    â””â”€â”€ <span class="nb">test</span>
        â””â”€â”€ java

</code></pre></div></div>

<p>æˆ‘å¹¶æœªå¯¹ HelloWorldServlet å’Œ HelloWorldFilter åšä»»ä½•æ”¹åŠ¨ï¼Œè€Œæ˜¯æ–°å¢äº†ä¸€ä¸ª CustomServletContainerInitializer ,å®ƒå®ç°äº† <code class="highlighter-rouge">java javax.servlet.ServletContainerInitializer</code> æ¥å£ï¼Œç”¨æ¥åœ¨ web å®¹å™¨å¯åŠ¨æ—¶åŠ è½½æŒ‡å®šçš„ servlet å’Œ filterï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServletContainerInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">JAR_HELLO_URL</span> <span class="o">=</span> <span class="s">"/hello"</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ›å»º helloWorldServlet..."</span><span class="o">);</span>

    <span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">servlet</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span>
            <span class="nc">HelloWorldServlet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
            <span class="nc">HelloWorldServlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">servlet</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="no">JAR_HELLO_URL</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ›å»º helloWorldFilter..."</span><span class="o">);</span>

    <span class="nc">FilterRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span>
            <span class="nc">HelloWorldFilter</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="nc">HelloWorldFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">DispatcherType</span><span class="o">&gt;</span> <span class="n">dispatcherTypes</span> <span class="o">=</span> <span class="nc">EnumSet</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">dispatcherTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">REQUEST</span><span class="o">);</span> 
    <span class="n">dispatcherTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">FORWARD</span><span class="o">);</span> 

    <span class="n">filter</span><span class="o">.</span><span class="na">addMappingForUrlPatterns</span><span class="o">(</span><span class="n">dispatcherTypes</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="no">JAR_HELLO_URL</span><span class="o">);</span>

  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å¯¹ä¸Šè¿°ä»£ç è¿›è¡Œä¸€äº›è§£è¯»ã€‚ServletContext æˆ‘ä»¬ç§°ä¹‹ä¸º servlet ä¸Šä¸‹æ–‡ï¼Œå®ƒç»´æŠ¤äº†æ•´ä¸ª web å®¹å™¨ä¸­æ³¨å†Œçš„ servletï¼Œfilterï¼Œlistenerï¼Œä»¥ servlet ä¸ºä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ servletContext.addServlet ç­‰æ–¹æ³•æ¥æ·»åŠ  servletã€‚è€Œæ–¹æ³•å…¥å‚ä¸­ Set&lt;Class<?>> c å’Œ @HandlesTypes æ³¨è§£åœ¨ demo ä¸­æˆ‘å¹¶æœªä½¿ç”¨ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ debug çœ‹çœ‹åˆ°åº•è·å–äº†å“ªäº› class ï¼Œä¸€èˆ¬æ­£å¸¸çš„æµç¨‹æ˜¯ä½¿ç”¨ @HandlesTypes æŒ‡å®šéœ€è¦å¤„ç†çš„ classï¼Œè€Œåå¯¹ Set<Class<?>&gt; è¿›è¡Œåˆ¤æ–­æ˜¯å¦å±äºè¯¥ classï¼Œæ­£å¦‚å‰æ–‡æ‰€è¨€ï¼ŒonStartup ä¼šåŠ è½½ä¸éœ€è¦è¢«å¤„ç†çš„ä¸€äº› classã€‚</p>

<p>è¿™ä¹ˆå£°æ˜ä¸€ä¸ª ServletContainerInitializer çš„å®ç°ç±»ï¼Œweb å®¹å™¨å¹¶ä¸ä¼šè¯†åˆ«å®ƒï¼Œæ‰€ä»¥ï¼Œéœ€è¦å€ŸåŠ© SPI æœºåˆ¶æ¥æŒ‡å®šè¯¥åˆå§‹åŒ–ç±»ï¼Œè¿™ä¸€æ­¥éª¤æ˜¯é€šè¿‡åœ¨é¡¹ç›®è·¯å¾„ä¸‹åˆ›å»º <code class="highlighter-rouge">shell META-INF/services/javax.servlet.ServletContainerInitializer</code> æ¥åšåˆ°çš„ï¼Œå®ƒåªåŒ…å«ä¸€è¡Œå†…å®¹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moe.cnkirito.CustomServletContainerInitializer
</code></pre></div></div>

<p>ä½¿ç”¨ ServletContainerInitializer å’Œ SPI æœºåˆ¶ï¼Œæˆ‘ä»¬çš„ web åº”ç”¨ä¾¿å¯ä»¥å½»åº•æ‘†è„± web.xml äº†ã€‚</p>

<h2 id="spring-æ˜¯å¦‚ä½•æ”¯æŒ-servlet30-çš„">Spring æ˜¯å¦‚ä½•æ”¯æŒ servlet3.0 çš„ï¼Ÿ</h2>

<p>å›åˆ°æˆ‘ä»¬çš„ spring å…¨å®¶æ¡¶ï¼Œå¯èƒ½å·²ç»å¿˜äº†å…·ä½“æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹ä¸å†™ web.xml äº†ï¼Œæˆ‘åªçŸ¥é“ç°åœ¨çš„é¡¹ç›®å·²ç»å†ä¹Ÿçœ‹ä¸åˆ°å®ƒäº†ï¼Œspring åˆæ˜¯å¦‚ä½•æ”¯æŒ servlet3.0 è§„èŒƒçš„å‘¢ï¼Ÿ</p>

<p>å¯»æ‰¾ spring ä¸­ ServletContainerInitializer çš„å®ç°ç±»å¹¶ä¸å›°éš¾ï¼Œå¯ä»¥è¿…é€Ÿå®šä½åˆ° SpringServletContainerInitializer è¯¥å®ç°ç±»ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@HandlesTypes</span><span class="o">(</span><span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringServletContainerInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">webAppInitializerClasses</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>

		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">WebApplicationInitializer</span><span class="o">&gt;</span> <span class="n">initializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">WebApplicationInitializer</span><span class="o">&gt;();</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">webAppInitializerClasses</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">waiClass</span> <span class="o">:</span> <span class="n">webAppInitializerClasses</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Be defensive: Some servlet containers provide us with invalid classes,</span>
				<span class="c1">// no matter what @HandlesTypes says...</span>
                <span class="c1">// &lt;1&gt;</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">waiClass</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">(</span><span class="n">waiClass</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
						<span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">waiClass</span><span class="o">))</span> <span class="o">{</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">initializers</span><span class="o">.</span><span class="na">add</span><span class="o">((</span><span class="nc">WebApplicationInitializer</span><span class="o">)</span> <span class="n">waiClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
					<span class="o">}</span>
					<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="s">"Failed to instantiate WebApplicationInitializer class"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">initializers</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">servletContext</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="s">"No Spring WebApplicationInitializer types detected on classpath"</span><span class="o">);</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">servletContext</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">initializers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Spring WebApplicationInitializers detected on classpath"</span><span class="o">);</span>
		<span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
        <span class="c1">// &lt;2&gt;</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">WebApplicationInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">initializer</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æŸ¥çœ‹å…¶ java docï¼Œæè¿°å¦‚ä¸‹ï¼š</p>

<blockquote>
  <p>Servlet 3.0 {@link ServletContainerInitializer} designed to support code-based configuration of the servlet container using Springâ€™s {@link WebApplicationInitializer} SPI as opposed to (or possibly in combination with) the traditional {@code web.xml}-based approach.</p>
</blockquote>

<p>æ³¨æ„æˆ‘åœ¨æºç ä¸­æ ‡æ³¨ä¸¤ä¸ªåºå·ï¼Œè¿™å¯¹äºæˆ‘ä»¬ç†è§£ spring è£…é… servlet çš„æµç¨‹æ¥è¯´éå¸¸é‡è¦ã€‚</p>

<p>&lt;1&gt; è‹±æ–‡æ³¨é‡Šæ˜¯ spring æºç ä¸­è‡ªå¸¦çš„ï¼Œå®ƒæç¤ºæˆ‘ä»¬ç”±äº servlet å‚å•†å®ç°çš„å·®å¼‚ï¼ŒonStartup æ–¹æ³•ä¼šåŠ è½½æˆ‘ä»¬æœ¬ä¸æƒ³å¤„ç†çš„ classï¼Œæ‰€ä»¥è¿›è¡Œäº†ç‰¹åˆ¤ã€‚</p>

<p>&lt;2&gt; spring ä¸æˆ‘ä»¬ä¹‹å‰çš„ demo ä¸åŒï¼Œå¹¶æ²¡æœ‰åœ¨ SpringServletContainerInitializer ä¸­ç›´æ¥å¯¹ servlet å’Œ filter è¿›è¡Œæ³¨å†Œï¼Œè€Œæ˜¯å§”æ‰˜ç»™äº†ä¸€ä¸ªé™Œç”Ÿçš„ç±» WebApplicationInitializer ï¼ŒWebApplicationInitializer ç±»ä¾¿æ˜¯ spring ç”¨æ¥åˆå§‹åŒ– web ç¯å¢ƒçš„å§”æ‰˜è€…ç±»ï¼Œå®ƒé€šå¸¸æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼š</p>

<p><img src="http://kirito.iocoder.cn/WebApplicationInitializer.png" alt="WebApplicationInitializer" /></p>

<p>ä½ ä¸€å®šä¸ä¼šå¯¹ dispatcherServlet æ„Ÿåˆ°é™Œç”Ÿï¼ŒAbstractDispatcherServletInitializer#registerDispatcherServlet ä¾¿æ˜¯æ—  web.xml å‰æä¸‹åˆ›å»º dispatcherServlet çš„å…³é”®ä»£ç ã€‚</p>

<p>å¯ä»¥å»é¡¹ç›®ä¸­å¯»æ‰¾ä¸€ä¸‹ org.springframework:spring-web:version çš„ä¾èµ–ï¼Œå®ƒä¸‹é¢å°±å­˜åœ¨ä¸€ä¸ª servletContainerInitializer çš„æ‰©å±•ï¼ŒæŒ‡å‘äº† SpringServletContainerInitializerï¼Œè¿™æ ·åªè¦åœ¨ servlet3.0 ç¯å¢ƒä¸‹éƒ¨ç½²ï¼Œspring ä¾¿å¯ä»¥è‡ªåŠ¨åŠ è½½è¿›è¡Œåˆå§‹åŒ–ï¼š</p>

<p><img src="http://kirito.iocoder.cn/F835D518-A725-40D9-84BA-6AC014DAE5A7.png" alt="SpringServletContainerInitializer" /></p>

<p>æ³¨æ„ï¼Œä¸Šè¿°è¿™ä¸€åˆ‡ç‰¹æ€§ä» spring 3 å°±å·²ç»å­˜åœ¨äº†ï¼Œè€Œå¦‚ä»Š spring 5 å·²ç»ä¼´éš springboot 2.0 ä¸€èµ·å‘è¡Œäº†ã€‚</p>

<h2 id="springboot-å¦‚ä½•åŠ è½½-servlet">SpringBoot å¦‚ä½•åŠ è½½ Servletï¼Ÿ</h2>

<p>è¯»åˆ°è¿™å„¿ï¼Œä½ å·²ç»é˜…è¯»äº†å…¨æ–‡çš„ 1/2ã€‚springboot å¯¹äº servlet çš„å¤„ç†æ‰æ˜¯é‡å¤´æˆï¼Œå…¶ä¸€ï¼Œæ˜¯å› ä¸º springboot ä½¿ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œå¾ˆå°‘æœ‰äººç”¨ spring è€Œä¸ç”¨ springboot äº†ï¼›å…¶äºŒï¼Œæ˜¯å› ä¸ºå®ƒæ²¡æœ‰å®Œå…¨éµå®ˆ servlet3.0 çš„è§„èŒƒï¼</p>

<p>æ˜¯çš„ï¼Œå‰é¢æ‰€è®²è¿°çš„ servlet çš„è§„èŒƒï¼Œæ— è®ºæ˜¯ web.xml ä¸­çš„é…ç½®ï¼Œè¿˜æ˜¯ servlet3.0 ä¸­çš„ ServletContainerInitializer å’Œ springboot çš„åŠ è½½æµç¨‹éƒ½æ²¡æœ‰å¤ªå¤§çš„å…³è”ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œå…ˆå–ä¸ªå…³å­ï¼Œå…ˆçœ‹çœ‹å¦‚ä½•åœ¨ springboot ä¸­æ³¨å†Œ servlet å’Œ filterï¼Œå†æ¥è§£é‡Šä¸‹ springboot çš„ç‹¬ç‰¹ä¹‹å¤„ã€‚</p>

<h3 id="æ³¨å†Œæ–¹å¼ä¸€servlet30æ³¨è§£servletcomponentscan">æ³¨å†Œæ–¹å¼ä¸€ï¼šservlet3.0æ³¨è§£+@ServletComponentScan</h3>
<p>springboot ä¾æ—§å…¼å®¹ servlet3.0 ä¸€ç³»åˆ—ä»¥ @Web* å¼€å¤´çš„æ³¨è§£ï¼š@WebServletï¼Œ@WebFilterï¼Œ@WebListener</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebFilter</span><span class="o">(</span><span class="s">"/hello/*"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{}</span>
</code></pre></div></div>

<p>ä¸è¦å¿˜è®°è®©å¯åŠ¨ç±»å»æ‰«æåˆ°è¿™äº›æ³¨è§£</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@ServletComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringBootServletApplication</span> <span class="o">{</span>

   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">SpringBootServletApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>æˆ‘è®¤ä¸ºè¿™æ˜¯å‡ ç§æ–¹å¼ä¸­æœ€ä¸ºç®€æ´çš„æ–¹å¼ï¼Œå¦‚æœçœŸçš„æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œéœ€è¦åœ¨ springboot ä¸‹æ³¨å†Œ servletï¼Œfilterï¼Œå¯ä»¥é‡‡ç”¨è¿™æ ·çš„æ–¹å¼ï¼Œæ¯”è¾ƒç›´è§‚ã€‚</p>

<h3 id="æ³¨å†Œæ–¹å¼äºŒregistrationbean">æ³¨å†Œæ–¹å¼äºŒï¼šRegistrationBean</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ServletRegistrationBean</span> <span class="nf">helloWorldServlet</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ServletRegistrationBean</span> <span class="n">helloWorldServlet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServletRegistrationBean</span><span class="o">();</span>
    <span class="n">myServlet</span><span class="o">.</span><span class="na">addUrlMappings</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">);</span>
    <span class="n">myServlet</span><span class="o">.</span><span class="na">setServlet</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorldServlet</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">helloWorldServlet</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">FilterRegistrationBean</span> <span class="nf">helloWorldFilter</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">FilterRegistrationBean</span> <span class="n">helloWorldFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FilterRegistrationBean</span><span class="o">();</span>
    <span class="n">myFilter</span><span class="o">.</span><span class="na">addUrlPatterns</span><span class="o">(</span><span class="s">"/hello/*"</span><span class="o">);</span>
    <span class="n">myFilter</span><span class="o">.</span><span class="na">setFilter</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorldFilter</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">helloWorldFilter</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ServletRegistrationBean å’Œ FilterRegistrationBean éƒ½é›†æˆè‡ª RegistrationBean ï¼ŒRegistrationBean æ˜¯ springboot ä¸­å¹¿æ³›åº”ç”¨çš„ä¸€ä¸ªæ³¨å†Œç±»ï¼Œè´Ÿè´£æŠŠ servletï¼Œfilterï¼Œlistener ç»™å®¹å™¨åŒ–ï¼Œä½¿ä»–ä»¬è¢« spring æ‰˜ç®¡ï¼Œå¹¶ä¸”å®Œæˆè‡ªèº«å¯¹ web å®¹å™¨çš„æ³¨å†Œã€‚è¿™ç§æ³¨å†Œæ–¹å¼ä¹Ÿå€¼å¾—æ¨å´‡ã€‚</p>

<p><img src="http://kirito.iocoder.cn/RegistrationBean.png" alt="RegistrationBean" /></p>

<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡º RegistrationBean çš„åœ°ä½ï¼Œå®ƒçš„å‡ ä¸ªå®ç°ç±»ä½œç”¨åˆ†åˆ«æ˜¯ï¼šå¸®åŠ©å®¹å™¨æ³¨å†Œ filterï¼Œservletï¼Œlistenerï¼Œæœ€åçš„ DelegatingFilterProxyRegistrationBean ä½¿ç”¨çš„ä¸å¤šï¼Œä½†ç†Ÿæ‚‰ SpringSecurity çš„æœ‹å‹ä¸ä¼šæ„Ÿåˆ°é™Œç”Ÿï¼ŒSpringSecurityFilterChain å°±æ˜¯é€šè¿‡è¿™ä¸ªä»£ç†ç±»æ¥è°ƒç”¨çš„ã€‚å¦å¤– RegistrationBean å®ç°äº† ServletContextInitializer æ¥å£ï¼Œè¿™ä¸ªæ¥å£å°†ä¼šæ˜¯ä¸‹é¢åˆ†æçš„æ ¸å¿ƒæ¥å£ï¼Œå¤§å®¶å…ˆæ··ä¸ªçœ¼ç†Ÿï¼Œäº†è§£ä¸‹å®ƒæœ‰ä¸€ä¸ªæŠ½è±¡å®ç° RegistrationBean å³å¯ã€‚</p>

<h2 id="springbootä¸­servletåŠ è½½æµç¨‹çš„æºç åˆ†æ">SpringBootä¸­servletåŠ è½½æµç¨‹çš„æºç åˆ†æ</h2>

<p>æš‚æ—¶åªä»‹ç»è¿™ä¸¤ç§æ–¹å¼ï¼Œä¸‹é¢è§£é‡Šä¸‹ä¹‹å‰å–çš„å…³å­ï¼Œä¸ºä»€ä¹ˆè¯´ springboot æ²¡æœ‰å®Œå…¨éµå®ˆ servlet3.0 è§„èŒƒã€‚è®¨è®ºçš„å‰ææ˜¯ springboot ç¯å¢ƒä¸‹ä½¿ç”¨å†…åµŒçš„å®¹å™¨ï¼Œæ¯”å¦‚æœ€å…¸å‹çš„ tomcatã€‚é«˜èƒ½é¢„è­¦ï¼Œä»¥ä¸‹å†…å®¹æ¯”è¾ƒçƒ§è„‘ï¼Œè§‰å¾—çœ‹èµ·æ¥åƒåŠ›çš„æœ‹å‹å¯ä»¥è·³è¿‡æœ¬èŠ‚ç›´æ¥çœ‹ä¸‹ä¸€èŠ‚çš„æ€»ç»“ï¼</p>

<h3 id="initializerè¢«æ›¿æ¢ä¸ºtomcatstarter">Initializerè¢«æ›¿æ¢ä¸ºTomcatStarter</h3>

<p>å½“ä½¿ç”¨å†…åµŒçš„ tomcat æ—¶ï¼Œä½ ä¼šå‘ç° springboot å®Œå…¨èµ°äº†å¦ä¸€å¥—åˆå§‹åŒ–æµç¨‹ï¼Œå®Œå…¨æ²¡æœ‰ä½¿ç”¨å‰é¢æåˆ°çš„ SpringServletContainerInitializerï¼Œå®é™…ä¸Šä¸€å¼€å§‹æˆ‘åœ¨å„ç§ ServletContainerInitializer çš„å®ç°ç±»ä¸­æ‰“äº†æ–­ç‚¹ï¼Œæœ€ç»ˆå®šä½åˆ°ï¼Œæ ¹æœ¬æ²¡æœ‰è¿è¡Œåˆ° SpringServletContainerInitializer å†…éƒ¨ï¼Œè€Œæ˜¯è¿›å…¥äº† TomcatStarter è¿™ä¸ªç±»ä¸­ã€‚</p>

<p><img src="http://kirito.iocoder.cn/TomcatStarter.png" alt="TomcatStarter" /></p>

<p>å¹¶ä¸”ï¼Œä»”ç»†æ‰«äº†ä¸€çœ¼æºç çš„åŒ…ï¼Œå¹¶æ²¡æœ‰å‘ç°æœ‰ SPI æ–‡ä»¶å¯¹åº”åˆ° TomcatStarterã€‚äºæ˜¯æˆ‘çŒœæƒ³ï¼Œå†…åµŒ tomcat çš„åŠ è½½å¯èƒ½ä¸ä¾èµ–äº servlet3.0 è§„èŒƒå’Œ SPIï¼å®ƒå®Œå…¨èµ°äº†ä¸€å¥—ç‹¬ç«‹çš„é€»è¾‘ã€‚ä¸ºäº†éªŒè¯è¿™ä¸€ç‚¹ï¼Œæˆ‘ç¿»é˜…äº† spring github ä¸­çš„ issueï¼Œå¾—åˆ°äº† spring ä½œè€…è‚¯å®šçš„ç­”å¤ï¼šhttps://github.com/spring-projects/spring-boot/issues/321</p>

<blockquote>
  <p>This was actually an intentional design decision. The search algorithm used by the containers was problematic. It also causes problems when you want to develop an executable WAR as you often want a javax.servlet.ServletContainerInitializer for the WAR that is not executed when you run java -jar. <br />
See the org.springframework.boot.context.embedded.ServletContextInitializer for an option that works with Spring Beans.</p>
</blockquote>

<p>pringboot è¿™ä¹ˆåšæ˜¯æœ‰æ„è€Œä¸ºä¹‹ã€‚springboot è€ƒè™‘åˆ°äº†å¦‚ä¸‹çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ springboot æ—¶ï¼Œå¼€å‘é˜¶æ®µä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨å†…åµŒ tomcat å®¹å™¨ï¼Œä½†éƒ¨ç½²æ—¶å´å­˜åœ¨ä¸¤ç§é€‰æ‹©ï¼šä¸€ç§æ˜¯æ‰“æˆ jar åŒ…ï¼Œä½¿ç”¨ java -jar çš„æ–¹å¼è¿è¡Œï¼›å¦ä¸€ç§æ˜¯æ‰“æˆ war åŒ…ï¼Œäº¤ç»™å¤–ç½®å®¹å™¨å»è¿è¡Œã€‚å‰è€…å°±ä¼šå¯¼è‡´å®¹å™¨æœç´¢ç®—æ³•å‡ºç°é—®é¢˜ï¼Œå› ä¸ºè¿™æ˜¯ jar åŒ…çš„è¿è¡Œç­–ç•¥ï¼Œä¸ä¼šæŒ‰ç…§ servlet3.0 çš„ç­–ç•¥å»åŠ è½½ ServletContainerInitializerï¼æœ€åä½œè€…è¿˜æä¾›äº†ä¸€ä¸ªæ›¿ä»£é€‰é¡¹ï¼šServletContextInitializerï¼Œæ³¨æ„æ˜¯ ServletContextInitializerï¼å®ƒå’Œ ServletContainerInitializer é•¿å¾—ç‰¹åˆ«åƒï¼Œåˆ«ææ··æ·†äº†ï¼Œå‰è€… ServletContextInitializer æ˜¯ org.springframework.boot.web.servlet.ServletContextInitializerï¼Œåè€… ServletContainerInitializer æ˜¯ javax.servlet.ServletContainerInitializerï¼Œå‰æ–‡è¿˜æåˆ° RegistrationBean å®ç°äº† ServletContextInitializer æ¥å£ã€‚</p>

<h3 id="tomcatstarterä¸­çš„servletcontextinitializeræ˜¯å…³é”®">TomcatStarterä¸­çš„ServletContextInitializeræ˜¯å…³é”®</h3>

<p>TomcatStarter ä¸­çš„ org.springframework.boot.context.embedded.ServletContextInitializer æ˜¯ springboot åˆå§‹åŒ– servletï¼Œfilterï¼Œlistener çš„å…³é”®ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TomcatStarter</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">;</span>

   <span class="nc">TomcatStarter</span><span class="o">(</span><span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">initializers</span> <span class="o">=</span> <span class="n">initializers</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span>
         <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
         <span class="k">for</span> <span class="o">(</span><span class="nc">ServletContextInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">initializers</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">initializer</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
         <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç»è¿‡åˆ å‡æºç åï¼Œå¯ä»¥çœ‹å‡º TomcatStarter çš„ä¸»è¦é€»è¾‘ï¼Œå®ƒå…¶å®å°±æ˜¯è´Ÿè´£è°ƒç”¨ä¸€ç³»åˆ— ServletContextInitializer çš„ onStartup æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨ debug ä¸­ï¼ŒServletContextInitializer[] initializers åˆ°åº•åŒ…å«äº†å“ªäº›ç±»å‘¢ï¼Ÿä¼šä¸ä¼šæœ‰æˆ‘ä»¬å‰é¢ä»‹ç»çš„ RegisterBean å‘¢ï¼Ÿ</p>

<p><img src="http://kirito.iocoder.cn/35560726-DD9D-478A-BFCA-12ACF4DB497D.png" alt="initializers" /></p>

<p>å¤ªå¤©çœŸäº†ï¼ŒRegisterBean å¹¶æ²¡æœ‰å‡ºç°åœ¨ TomcatStarter çš„ debug ä¿¡æ¯ä¸­ï¼Œinitializers åªåŒ…å«äº†ä¸‰ä¸ªç±»ï¼Œå…¶ä¸­åªæœ‰ç¬¬ä¸€ä¸ªç±»çœ‹ä¸Šå»æ¯”è¾ƒæ ¸å¿ƒï¼Œæ³¨æ„ç¬¬ä¸€ä¸ªç±»ä¸æ˜¯ EmbeddedWebApplicationContextï¼è€Œæ˜¯è¿™ä¸ªç±»ä¸­çš„ $1 åŒ¿åç±»ï¼Œä¸ºäº†ææ¸…æ¥š springboot å¦‚ä½•åŠ è½½ filter servlet listener ï¼Œçœ‹æ¥è¿˜å¾—ç ”ç©¶ä¸‹ EmbeddedWebApplicationContext çš„ç»“æ„ã€‚</p>

<h2 id="embeddedwebapplicationcontextä¸­çš„6å±‚è¿­ä»£åŠ è½½">EmbeddedWebApplicationContextä¸­çš„6å±‚è¿­ä»£åŠ è½½</h2>

<p>ApplicationContext å¤§å®¶åº”è¯¥æ˜¯æ¯”è¾ƒç†Ÿæ‚‰çš„ï¼Œè¿™æ˜¯ spring ä¸€ä¸ªæ¯”è¾ƒæ ¸å¿ƒçš„ç±»ï¼Œä¸€èˆ¬æˆ‘ä»¬å¯ä»¥ä»ä¸­è·å–åˆ°é‚£äº›æ³¨å†Œåœ¨å®¹å™¨ä¸­çš„æ‰˜ç®¡ Beanï¼Œè€Œè¿™ç¯‡æ–‡ç« ï¼Œä¸»è¦åˆ†æçš„ä¾¿æ˜¯å®ƒåœ¨å†…åµŒå®¹å™¨ä¸­çš„å®ç°ç±»ï¼šEmbeddedWebApplicationContextï¼Œé‡ç‚¹åˆ†æå®ƒåŠ è½½ filter servlet listener è¿™éƒ¨åˆ†çš„ä»£ç ã€‚è¿™é‡Œæ˜¯æ•´ä¸ªä»£ç ä¸­è¿­ä»£å±‚æ¬¡æœ€æ·±çš„éƒ¨åˆ†ï¼Œåšå¥½å¿ƒç†å‡†å¤‡èµ·èˆªï¼Œæ¥çœ‹çœ‹ EmbeddedWebApplicationContext æ˜¯æ€ä¹ˆè·å–åˆ°æ‰€æœ‰çš„ servlet filter listener çš„ï¼ä»¥ä¸‹æ–¹æ³•å‡å‡ºè‡ªäº EmbeddedWebApplicationContextã€‚</p>

<h3 id="ç¬¬ä¸€å±‚onrefresh">ç¬¬ä¸€å±‚ï¼šonRefresh()</h3>

<p>onRefresh æ˜¯ ApplicationContext çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ŒEmbeddedWebApplicationContext çš„å®ç°éå¸¸ç®€å•ï¼Œåªå¹²äº†ä¸€ä»¶äº‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRefresh</span><span class="o">()</span> <span class="o">{</span>
   <span class="kd">super</span><span class="o">.</span><span class="na">onRefresh</span><span class="o">();</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="n">createEmbeddedServletContainer</span><span class="o">();</span><span class="c1">//ç¬¬äºŒå±‚çš„å…¥å£</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Unable to start embedded container"</span><span class="o">,</span>
            <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>createEmbeddedServletContainer è¿æ¥åˆ°äº†ç¬¬äºŒå±‚</p>

<h3 id="ç¬¬äºŒå±‚createembeddedservletcontainer">ç¬¬äºŒå±‚ï¼šcreateEmbeddedServletContainer()</h3>

<p>çœ‹åå­— spring æ˜¯æƒ³åˆ›å»ºä¸€ä¸ªå†…åµŒçš„ servlet å®¹å™¨ï¼ŒServletContainer å…¶å®å°±æ˜¯ servlet filter listener çš„æ€»ç§°ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">createEmbeddedServletContainer</span><span class="o">()</span> <span class="o">{</span>
   <span class="nc">EmbeddedServletContainer</span> <span class="n">localContainer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">embeddedServletContainer</span><span class="o">;</span>
   <span class="nc">ServletContext</span> <span class="n">localServletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">localContainer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">localServletContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">EmbeddedServletContainerFactory</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="n">getEmbeddedServletContainerFactory</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">embeddedServletContainer</span> <span class="o">=</span> <span class="n">containerFactory</span>
            <span class="o">.</span><span class="na">getEmbeddedServletContainer</span><span class="o">(</span><span class="n">getSelfInitializer</span><span class="o">());</span><span class="c1">//ç¬¬ä¸‰å±‚çš„å…¥å£</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">localServletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">getSelfInitializer</span><span class="o">().</span><span class="na">onStartup</span><span class="o">(</span><span class="n">localServletContext</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">ServletException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Cannot initialize servlet context"</span><span class="o">,</span>
               <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="n">initPropertySources</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å‡¡æ˜¯å¸¦æœ‰ servletï¼Œinitializer å­—æ ·çš„æ–¹æ³•éƒ½æ˜¯æˆ‘ä»¬éœ€è¦ç•™æ„çš„ï¼ŒgetSelfInitializer() ä¾¿æ¶‰åŠåˆ°äº†æˆ‘ä»¬æœ€ä¸ºå…³å¿ƒçš„åˆå§‹åŒ–æµç¨‹ã€‚</p>

<h3 id="ç¬¬ä¸‰å±‚getselfinitializer">ç¬¬ä¸‰å±‚ï¼šgetSelfInitializer()</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">ServletContextInitializer</span> <span class="nf">getSelfInitializer</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nf">ServletContextInitializer</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
         <span class="n">selfInitialize</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">};</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">selfInitialize</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
   <span class="n">prepareEmbeddedWebApplicationContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
   <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="o">();</span>
   <span class="nc">ExistingWebApplicationScopes</span> <span class="n">existingScopes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExistingWebApplicationScopes</span><span class="o">(</span>
         <span class="n">beanFactory</span><span class="o">);</span>
   <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">registerWebApplicationScopes</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span>
         <span class="n">getServletContext</span><span class="o">());</span>
   <span class="n">existingScopes</span><span class="o">.</span><span class="na">restore</span><span class="o">();</span>
   <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">registerEnvironmentBeans</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span>
         <span class="n">getServletContext</span><span class="o">());</span>
   <span class="c1">//ç¬¬å››å±‚çš„å…¥å£</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">ServletContextInitializer</span> <span class="n">beans</span> <span class="o">:</span> <span class="n">getServletContextInitializerBeans</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">beans</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿˜è®°å¾—å‰é¢ TomcatStarter çš„ debug ä¿¡æ¯ä¸­ï¼Œç¬¬ä¸€ä¸ª ServletContextInitializer å°±æ˜¯å‡ºç°åœ¨ EmbeddedWebApplicationContext ä¸­çš„ä¸€ä¸ªåŒ¿åç±»ï¼Œæ²¡é”™äº†ï¼Œå°±æ˜¯è¿™é‡Œçš„ getSelfInitializer() æ–¹æ³•åˆ›å»ºçš„ï¼è§£é‡Šä¸‹è¿™é‡Œçš„ getSelfInitializer() å’Œ selfInitialize(ServletContext servletContext) ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼šè¿™æ˜¯å…¸å‹çš„å›è°ƒå¼æ–¹å¼ï¼Œå½“åŒ¿å ServletContextInitializer ç±»è¢« TomcatStarter çš„ onStartup æ–¹æ³•è°ƒç”¨ï¼Œè®¾è®¡ä¸Šæ˜¯è§¦å‘äº† selfInitialize(ServletContext servletContext) çš„è°ƒç”¨ã€‚æ‰€ä»¥è¿™ä¸‹å°±æ¸…æ™°äº†ï¼Œä¸ºä»€ä¹ˆ TomcatStarter ä¸­æ²¡æœ‰å‡ºç° RegisterBean ï¼Œå…¶å®æ˜¯éšå¼è§¦å‘äº† EmbeddedWebApplicationContext ä¸­çš„ selfInitialize æ–¹æ³•ã€‚selfInitialize æ–¹æ³•ä¸­çš„ getServletContextInitializerBeans() æˆäº†å…³é”®ã€‚</p>

<h3 id="ç¬¬å››å±‚getservletcontextinitializerbeans">ç¬¬å››å±‚ï¼šgetServletContextInitializerBeans()</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Returns {@link ServletContextInitializer}s that should be used with the embedded
 * Servlet context. By default this method will first attempt to find
 * {@link ServletContextInitializer}, {@link Servlet}, {@link Filter} and certain
 * {@link EventListener} beans.
 * @return the servlet initializer beans
 */</span>
<span class="kd">protected</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="nf">getServletContextInitializerBeans</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nf">ServletContextInitializerBeans</span><span class="o">(</span><span class="n">getBeanFactory</span><span class="o">());</span><span class="c1">//ç¬¬äº”å±‚çš„å…¥å£</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ²¡é”™äº†ï¼Œæ³¨é‡Šéƒ½å‘Šè¯‰æˆ‘ä»¬ï¼Œè¿™ä¸ª ServletContextInitializerBeans æ˜¯ç”¨æ¥åŠ è½½ Servlet å’Œ Filter çš„ã€‚</p>

<h3 id="ç¬¬äº”å±‚servletcontextinitializerbeansçš„æ„é€ æ–¹æ³•">ç¬¬äº”å±‚ï¼šServletContextInitializerBeansçš„æ„é€ æ–¹æ³•</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">ServletContextInitializerBeans</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">initializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedMultiValueMap</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">ServletContextInitializer</span><span class="o">&gt;();</span>
   <span class="n">addServletContextInitializerBeans</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span><span class="c1">// ç¬¬å…­å±‚çš„å…¥å£</span>
   <span class="n">addAdaptableBeans</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="n">sortedInitializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;();</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">initializers</span>
         <span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
      <span class="n">sortedInitializers</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="k">this</span><span class="o">.</span><span class="na">sortedList</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">sortedInitializers</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ç¬¬å…­å±‚addservletcontextinitializerbeansbeanfactory">ç¬¬å…­å±‚ï¼šaddServletContextInitializerBeans(beanFactory)</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addServletContextInitializerBeans</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="n">initializerBean</span> <span class="o">:</span> <span class="n">getOrderedBeansOfType</span><span class="o">(</span>
         <span class="n">beanFactory</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">addServletContextInitializerBean</span><span class="o">(</span><span class="n">initializerBean</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span>
            <span class="n">initializerBean</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">beanFactory</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>getOrderedBeansOfType æ–¹æ³•ä¾¿æ˜¯å»å®¹å™¨ä¸­å¯»æ‰¾æ³¨å†Œè¿‡å¾— ServletContextInitializer ï¼Œè¿™æ—¶å€™å°±å¯ä»¥æŠŠä¹‹å‰é‚£äº› RegisterBean å…¨éƒ¨åŠ è½½å‡ºæ¥äº†ï¼Œå¹¶ä¸” RegisterBean è¿˜å®ç°äº† Ordered æ¥å£ï¼Œåœ¨è¿™å„¿ç”¨äºæ’åºã€‚ä¸å†å¾€ä¸‹è¿­ä»£äº†ã€‚</p>

<h2 id="embeddedwebapplicationcontextåŠ è½½æµç¨‹æ€»ç»“">EmbeddedWebApplicationContextåŠ è½½æµç¨‹æ€»ç»“</h2>

<p>å¦‚æœä½ å¯¹å…·ä½“çš„ä»£ç æµç¨‹ä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥è·³è¿‡ä¸Šè¿°çš„6å±‚åˆ†æï¼Œç›´æ¥çœ‹æœ¬èŠ‚çš„ç»“è®ºã€‚æ€»ç»“å¦‚ä¸‹ï¼š</p>

<ul>
  <li>EmbeddedWebApplicationContext çš„ onRefresh æ–¹æ³•è§¦å‘é…ç½®äº†ä¸€ä¸ªåŒ¿åçš„ ServletContextInitializerã€‚</li>
  <li>è¿™ä¸ªåŒ¿åçš„ ServletContextInitializer çš„ onStartup æ–¹æ³•ä¼šå»å®¹å™¨ä¸­æœç´¢åˆ°äº†æ‰€æœ‰çš„ RegisterBean å¹¶æŒ‰ç…§é¡ºåºåŠ è½½åˆ° ServletContext ä¸­ã€‚</li>
  <li>è¿™ä¸ªåŒ¿åçš„ ServletContextInitializer æœ€ç»ˆä¼ é€’ç»™ TomcatStarterï¼Œç”± TomcatStarter çš„ onStartup æ–¹æ³•å»è§¦å‘ ServletContextInitializer çš„ onStartup æ–¹æ³•ï¼Œæœ€ç»ˆå®Œæˆè£…é…ï¼</li>
</ul>

<p><img src="http://kirito.iocoder.cn/8FFCA673-DB72-4C0A-BDE9-58CB4B80C484.png" alt="getServletContextInitializerBeans" /></p>

<h2 id="ç¬¬ä¸‰ç§æ³¨å†Œ-servlet-çš„æ–¹å¼">ç¬¬ä¸‰ç§æ³¨å†Œ Servlet çš„æ–¹å¼</h2>

<p>ç ”ç©¶å®Œäº†ä¸Šè¿° springboot å¯åŠ¨çš„å†…éƒ¨åŸç†ï¼Œå¯ä»¥å‘ç° ServletContextInitializer å…¶å®æ˜¯ spring ä¸­ ServletContainerInitializer çš„ä»£ç†ï¼Œè™½ç„¶ springboot ä¸­ Servlet3.0 ä¸èµ·ä½œç”¨äº†ï¼Œä½†å®ƒçš„ä»£ç†è¿˜æ˜¯ä¼šè¢«åŠ è½½çš„ï¼Œäºæ˜¯æˆ‘ä»¬æœ‰äº†ç¬¬ä¸‰ç§æ–¹å¼æ³¨å†Œ servletã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServletContextInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContextInitializer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">JAR_HELLO_URL</span> <span class="o">=</span> <span class="s">"/hello"</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ›å»º helloWorldServlet..."</span><span class="o">);</span>

        <span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">servlet</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span>
                <span class="nc">HelloWorldServlet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
                <span class="nc">HelloWorldServlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">servlet</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="no">JAR_HELLO_URL</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ›å»º helloWorldFilter..."</span><span class="o">);</span>

        <span class="nc">FilterRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span>
                <span class="nc">HelloWorldFilter</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="nc">HelloWorldFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">DispatcherType</span><span class="o">&gt;</span> <span class="n">dispatcherTypes</span> <span class="o">=</span> <span class="nc">EnumSet</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">dispatcherTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">REQUEST</span><span class="o">);</span>
        <span class="n">dispatcherTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">FORWARD</span><span class="o">);</span>

        <span class="n">filter</span><span class="o">.</span><span class="na">addMappingForUrlPatterns</span><span class="o">(</span><span class="n">dispatcherTypes</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="no">JAR_HELLO_URL</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è™½ç„¶ ServletCantainerInitializer ä¸èƒ½è¢«å†…åµŒå®¹å™¨åŠ è½½ï¼ŒServletContextInitializer å´èƒ½è¢« springboot çš„ EmbeddedWebApplicationContext åŠ è½½åˆ°ï¼Œä»è€Œè£…é…å…¶ä¸­çš„ servlet å’Œ filterã€‚å®é™…å¼€å‘ä¸­ï¼Œè¿˜æ˜¯ä»¥ä¸€ï¼ŒäºŒä¸¤ç§æ–¹æ³•æ¥æ³¨å†Œä¸ºä¸»ï¼Œè¿™é‡Œåªæ˜¯æä¾›ä¸€ä¸ªå¯èƒ½æ€§ï¼Œæ¥è®©æˆ‘ä»¬ç†è§£ springboot çš„åŠ è½½æµç¨‹ã€‚</p>

<blockquote>
  <p>æ›´æ–°è‡³ 19å¹´1æœˆ</p>
</blockquote>

<h2 id="åŠ è½½æµç¨‹æ‹¾é—">åŠ è½½æµç¨‹æ‹¾é—</h2>

<h3 id="tomcatstarter-æ—¢ç„¶ä¸æ˜¯é€šè¿‡-spi-æœºåˆ¶è£…é…çš„é‚£æ˜¯æ€ä¹ˆè¢«-spring-ä½¿ç”¨çš„">TomcatStarter æ—¢ç„¶ä¸æ˜¯é€šè¿‡ SPI æœºåˆ¶è£…é…çš„ï¼Œé‚£æ˜¯æ€ä¹ˆè¢« spring ä½¿ç”¨çš„ï¼Ÿ</h3>

<p>è‡ªç„¶æ˜¯è¢« new å‡ºæ¥çš„ï¼Œåœ¨ TomcatEmbeddedServletContainerFactory#configureContext ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒTomcatStarter æ˜¯è¢«ä¸»åŠ¨å®ä¾‹åŒ–å‡ºæ¥çš„ï¼Œå¹¶ä¸”è¿˜ä¼ å…¥äº† ServletContextInitializer çš„æ•°ç»„ï¼Œå’Œä¸Šé¢åˆ†æçš„ä¸€æ ·ï¼Œä¸€å…±æœ‰ä¸‰ä¸ª ServletContextInitializerï¼ŒåŒ…å«äº† EmbeddedWebApplicationContext ä¸­çš„åŒ¿åå®ç°ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureContext</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span>
      <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">TomcatStarter</span> <span class="n">starter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TomcatStarter</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="k">instanceof</span> <span class="nc">TomcatEmbeddedContext</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Should be true</span>
      <span class="o">((</span><span class="nc">TomcatEmbeddedContext</span><span class="o">)</span> <span class="n">context</span><span class="o">).</span><span class="na">setStarter</span><span class="o">(</span><span class="n">starter</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="n">context</span><span class="o">.</span><span class="na">addServletContainerInitializer</span><span class="o">(</span><span class="n">starter</span><span class="o">,</span> <span class="no">NO_CLASSES</span><span class="o">);</span>
   <span class="o">...</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="tomcatembeddedservletcontainerfactory-åˆæ˜¯å¦‚ä½•è¢«å£°æ˜çš„">TomcatEmbeddedServletContainerFactory åˆæ˜¯å¦‚ä½•è¢«å£°æ˜çš„ï¼Ÿ</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@AutoConfigureOrder</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="nd">@ConditionalOnWebApplication</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">BeanPostProcessorsRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmbeddedServletContainerAutoConfiguration</span> <span class="o">{</span>

   <span class="cm">/**
    * Nested configuration if Tomcat is being used.
    */</span>
   <span class="nd">@Configuration</span>
   <span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="nc">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Tomcat</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
   <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">EmbeddedServletContainerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">search</span> <span class="o">=</span> <span class="nc">SearchStrategy</span><span class="o">.</span><span class="na">CURRENT</span><span class="o">)</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmbeddedTomcat</span> <span class="o">{</span>

      <span class="nd">@Bean</span>
      <span class="kd">public</span> <span class="nc">TomcatEmbeddedServletContainerFactory</span> <span class="nf">tomcatEmbeddedServletContainerFactory</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">TomcatEmbeddedServletContainerFactory</span><span class="o">();</span>
      <span class="o">}</span>

   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åªè¦ç±»è·¯å¾„ä¸‹å­˜åœ¨ Tomcat ç±»ï¼Œä»¥åŠåœ¨ web ç¯å¢ƒä¸‹ï¼Œå°±ä¼šè§¦å‘ springboot çš„è‡ªåŠ¨é…ç½®ã€‚</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>å­˜åœ¨ web.xml é…ç½®çš„ java web é¡¹ç›®ï¼Œservlet3.0 çš„ java web é¡¹ç›®ï¼Œspringboot å†…åµŒå®¹å™¨çš„ java web é¡¹ç›®åŠ è½½ servletï¼Œfilterï¼Œlistener çš„æµç¨‹éƒ½æ˜¯æœ‰æ‰€å·®å¼‚çš„ï¼Œç†è§£æ¸…æ¥šè¿™å…¶ä¸­çš„åŸæ¥ï¼Œå…¶å®å¹¶ä¸å®¹æ˜“ï¼Œè‡³å°‘å¾—ææ‡‚ servlet3.0 çš„è§„èŒƒï¼Œspringboot å†…åµŒå®¹å™¨çš„åŠ è½½æµç¨‹ç­‰ç­‰å‰ç½®é€»è¾‘ã€‚</p>

<p>æœ€åæ„Ÿè°¢ä¸‹å°é©¬å“¥çš„ç‚¹æ‹¨ï¼Œåœ¨æ­¤ä¹‹å‰è¯¯ä»¥ä¸ºï¼š TomcatStarter æ—¢ç„¶ç»§æ‰¿äº† ServletContainerInitializerï¼Œåº”è¯¥ä¹Ÿæ˜¯ç¬¦åˆ servlet3.0 è§„èŒƒçš„ï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰è¢« SPI åŠ è½½ã€‚</p>

<h2 id="æ¨èé˜…è¯»">æ¨èé˜…è¯»</h2>

<p>JAVAæ‹¾é—â€“å…³äºSPIæœºåˆ¶ https://www.cnkirito.moe/spi/</p>

:ET