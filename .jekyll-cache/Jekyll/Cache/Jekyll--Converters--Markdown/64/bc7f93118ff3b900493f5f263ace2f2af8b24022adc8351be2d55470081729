I"üK<h1 id="pythonè‡ªåŠ¨åŒ–éƒ¨ç½²">pythonè‡ªåŠ¨åŒ–éƒ¨ç½²</h1>

<h2 id="pexpectæ¡†æ¶">pexpectæ¡†æ¶</h2>

<p>â€ƒâ€ƒPexpect æ˜¯ Don Libes çš„ Expect è¯­è¨€çš„ä¸€ä¸ª Python å®ç°ï¼Œæ˜¯ä¸€ä¸ªç”¨æ¥å¯åŠ¨å­ç¨‹åºï¼Œå¹¶ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¯¹ç¨‹åºè¾“å‡ºåšå‡ºç‰¹å®šå“åº”ï¼Œä»¥æ­¤å®ç°ä¸å…¶è‡ªåŠ¨äº¤äº’çš„ Python æ¨¡å—ã€‚ Pexpect çš„ä½¿ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œå¯ä»¥ç”¨æ¥å®ç°ä¸ sshã€ftp ã€telnet ç­‰ç¨‹åºçš„è‡ªåŠ¨äº¤äº’ï¼›å¯ä»¥ç”¨æ¥è‡ªåŠ¨å¤åˆ¶è½¯ä»¶å®‰è£…åŒ…å¹¶åœ¨ä¸åŒæœºå™¨è‡ªåŠ¨å®‰è£…ï¼›è¿˜å¯ä»¥ç”¨æ¥å®ç°è½¯ä»¶æµ‹è¯•ä¸­ä¸å‘½ä»¤è¡Œäº¤äº’çš„è‡ªåŠ¨åŒ–ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding=utf_8
</span><span class="kn">import</span> <span class="nn">pexpect</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">'ssh std20@123.57.211.212'</span><span class="p">)</span>
<span class="n">child</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
<span class="c1">#fout = file('mylog.txt', 'w')
#child.logfile = fout
</span><span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
<span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'std20'</span><span class="p">)</span>
<span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">'std20.*'</span><span class="p">)</span>
<span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'ls /'</span><span class="p">)</span>
<span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">'std20.*'</span><span class="p">)</span>
<span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'exit'</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding=utf_8
# æ‰§è¡Œè¿œç¨‹ç³»ç»Ÿå‘½ä»¤
</span>
<span class="kn">from</span> <span class="nn">pexpect</span> <span class="kn">import</span> <span class="n">pxssh</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">pxssh</span><span class="o">.</span><span class="n">pxssh</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
<span class="n">hostname</span> <span class="o">=</span> <span class="s">'123.57.211.212'</span>
<span class="n">username</span> <span class="o">=</span> <span class="s">'std20'</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">'std20'</span>
<span class="n">s</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'ls /'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">prompt</span><span class="p">()</span>  <span class="c1">#åŒ¹é…ç³»ç»Ÿæç¤ºç¬¦
</span><span class="n">s</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'whoami'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">prompt</span><span class="p">()</span>  
<span class="n">s</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="fabricæ¡†æ¶">fabricæ¡†æ¶</h1>

<p>â€ƒâ€ƒé¡¹ç›®å‘å¸ƒå’Œè¿ç»´çš„å·¥ä½œç›¸å½“æœºæ¢°ï¼Œé¢‘ç‡è¿˜è›®é«˜ï¼Œå¯¼è‡´æ—¶é—´æµªè´¹åœ¨æ•²å¤§é‡é‡å¤çš„å‘½ä»¤ä¸Šã€‚</p>

<p>â€ƒâ€ƒä¿®å¤bugä»€ä¹ˆçš„ï¼Œæµ‹è¯•ï¼Œæäº¤ç‰ˆæœ¬åº“(2åˆ†é’Ÿ)ï¼Œsshåˆ°æµ‹è¯•ç¯å¢ƒpulléƒ¨ç½²ï¼ˆ2åˆ†é’Ÿï¼‰ï¼Œrsyncåˆ°çº¿ä¸Šæœºå™¨A,B,C,D,Eï¼ˆ1åˆ†é’Ÿï¼‰ï¼Œåˆ†åˆ«sshåˆ°ABCDEäº”å°æœºå™¨ï¼Œé€ä¸€é‡å¯(8-10åˆ†é’Ÿ) = 13-15åˆ†é’Ÿ</p>

<p>â€ƒâ€ƒå…¶ä¸­éƒé—·çš„æ˜¯ï¼Œæ¯æ¬¡æ“ä½œéƒ½æ˜¯ç›¸åŒçš„ï¼Œå‘½ä»¤ä¸€æ ·ï¼Œè¦å‘½çš„æ˜¯åœ¨å¤šä¸ªæœºå™¨ä¸Šï¼Œå¾ˆéš¾åœ¨æœ¬æœºä¸€ä¸ªè„šæœ¬æå®šï¼Œä¸»è¦æ—¶é—´éƒ½æµªè´¹åœ¨sshï¼Œæ•²å‘½ä»¤ä¸Šäº†ï¼Œå†™æˆè„šæœ¬ï¼Œå®Œå…¨å¯ä»¥ä¸€é”®æ‰§è¡Œï¼ŒèŠ±ä¸¤åˆ†é’Ÿçœ‹ä¸‹æ‰§è¡Œç»“æœã€‚</p>

<h3 id="å®‰è£…">å®‰è£…</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>fabric
</code></pre></div></div>

<h3 id="å…¥é—¨ç¤ºä¾‹">å…¥é—¨ç¤ºä¾‹</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#fabfile.py
</span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">run</span>

<span class="k">def</span> <span class="nf">host_type</span><span class="p">():</span>
    <span class="n">run</span><span class="p">(</span><span class="s">'uname -s'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>å¯åŠ¨</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>itcast@ubuntu:~/tmp/fab<span class="nv">$ </span>fab <span class="nt">-H</span> 127.0.0.1 host_type
<span class="o">[</span>127.0.0.1] Executing task <span class="s1">'host_type'</span>
<span class="o">[</span>127.0.0.1] run: <span class="nb">uname</span> <span class="nt">-s</span>
<span class="o">[</span>127.0.0.1] Login password <span class="k">for</span> <span class="s1">'itcast'</span>: 
<span class="o">[</span>127.0.0.1] out: Linux
<span class="o">[</span>127.0.0.1] out: 


Done.
Disconnecting from 127.0.0.1... <span class="k">done</span><span class="nb">.</span>
itcast@ubuntu:~/tmp/fab<span class="nv">$ </span>fab <span class="nt">-H</span> 127.0.0.1 host_type
<span class="o">[</span>127.0.0.1] Executing task <span class="s1">'host_type'</span>
<span class="o">[</span>127.0.0.1] run: <span class="nb">uname</span> <span class="nt">-s</span>
<span class="o">[</span>127.0.0.1] Login password <span class="k">for</span> <span class="s1">'itcast'</span>: 
<span class="o">[</span>127.0.0.1] out: Linux
<span class="o">[</span>127.0.0.1] out: 
</code></pre></div></div>

<h3 id="fabricå¸¸ç”¨å‚æ•°">fabricå¸¸ç”¨å‚æ•°</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-l</span> : æ˜¾ç¤ºå®šä¹‰å¥½çš„ä»»åŠ¡å‡½æ•°å
<span class="nt">-f</span> : æŒ‡å®šfabå…¥å£æ–‡ä»¶ï¼Œé»˜è®¤å…¥å£æ–‡ä»¶åä¸ºfabfile.py
<span class="nt">-H</span> : æŒ‡å®šç›®æ ‡ä¸»æœºï¼Œå¤šå°ä¸»æœºç”¨<span class="s2">","</span>å·åˆ†å‰²
</code></pre></div></div>

<h3 id="fabricå¸¸ç”¨api">fabricå¸¸ç”¨API</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">local</span> : æ‰§è¡Œæœ¬åœ°å‘½ä»¤ï¼Œå¦‚ï¼šlocal<span class="o">(</span><span class="s1">'uname -s'</span><span class="o">)</span>
lcd : åˆ‡æ¢æœ¬åœ°ç›®å½•ï¼Œå¦‚ï¼šlcd<span class="o">(</span><span class="s1">'/home'</span><span class="o">)</span>
<span class="nb">cd</span> : åˆ‡æ¢è¿œç¨‹ç›®å½•ï¼Œå¦‚ï¼šcd<span class="o">(</span><span class="s1">'/etc'</span><span class="o">)</span>
run : æ‰§è¡Œè¿œç¨‹å‘½ä»¤ï¼Œå¦‚ï¼šrun<span class="o">(</span><span class="s1">'free -m'</span><span class="o">)</span>
<span class="nb">sudo</span> : sudoæ–¹å¼æ‰§è¡Œè¿œç¨‹å‘½ä»¤ï¼Œå¦‚ï¼šsudo<span class="o">(</span><span class="s1">'touch /abc'</span><span class="o">)</span>
put : ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœºï¼Œå¦‚ï¼šput<span class="o">(</span><span class="s1">'/hello'</span>, <span class="s1">'/home/itcast/hello'</span><span class="o">)</span>
get : ä»è¿œç¨‹ä¸»æœºä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼Œå¦‚ï¼šget<span class="o">(</span><span class="s1">'/home/python/world'</span>, <span class="s1">'/home/itcast/world'</span><span class="o">)</span>
reboot : é‡å¯è¿œç¨‹ä¸»æœºï¼Œå¦‚ï¼šreboot<span class="o">()</span>
@task : å‡½æ•°è£…é¥°å™¨ï¼Œæ ‡è¯†çš„å‡½æ•°ä¸ºfabå¯è°ƒç”¨çš„ï¼Œéæ ‡è®°çš„å¯¹fabä¸å¯è§ï¼Œçº¯ä¸šåŠ¡é€»è¾‘
@runs_once : å‡½æ•°è£…é¥°å™¨ï¼Œæ ‡è¯†çš„å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸å—å¤šå°ä¸»æœºå½±å“
</code></pre></div></div>

<h3 id="fabricå…¨å±€å±æ€§è®¾å®š">fabricå…¨å±€å±æ€§è®¾å®š</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">env</span><span class="o">.</span><span class="n">host</span> <span class="p">:</span> <span class="err">å®šä¹‰ç›®æ ‡ä¸»æœºï¼Œå¦‚ï¼š</span><span class="n">env</span><span class="o">.</span><span class="n">host</span><span class="o">=</span><span class="p">[</span><span class="s">'192.168.17.192'</span><span class="p">,</span> <span class="s">'192.168.17.193'</span><span class="p">]</span>
<span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="p">:</span> <span class="err">å®šä¹‰ç”¨æˆ·åï¼Œå¦‚ï¼š</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">=</span><span class="s">"root"</span>
<span class="n">env</span><span class="o">.</span><span class="n">port</span> <span class="p">:</span> <span class="err">å®šä¹‰ç›®æ ‡ä¸»æœºç«¯å£ï¼Œé»˜è®¤ä¸º</span><span class="mi">22</span><span class="err">ï¼Œå¦‚ï¼š</span><span class="n">env</span><span class="o">.</span><span class="n">port</span><span class="o">=</span><span class="s">"22"</span>
<span class="n">env</span><span class="o">.</span><span class="n">password</span> <span class="p">:</span> <span class="err">å®šä¹‰å¯†ç ï¼Œå¦‚ï¼š</span><span class="n">env</span><span class="o">.</span><span class="n">password</span><span class="o">=</span><span class="s">"chuanzhi"</span>
<span class="n">env</span><span class="o">.</span><span class="n">passwords</span> <span class="p">:</span> <span class="err">ä¸åŒçš„ä¸»æœºä¸åŒçš„å¯†ç ï¼Œå¦‚ï¼š</span><span class="n">env</span><span class="o">.</span><span class="n">passwords</span><span class="o">=</span><span class="p">{</span><span class="s">'itcast@192.168.17.192:22'</span><span class="p">:</span><span class="s">'chuanzhi'</span><span class="p">,</span> <span class="s">'itcast@192.168.17.193:22'</span><span class="p">:</span><span class="s">'python'</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="ç¤ºä¾‹1åŠ¨æ€è·å–è¿œç¨‹ç›®å½•åˆ—è¡¨">ç¤ºä¾‹1ï¼šåŠ¨æ€è·å–è¿œç¨‹ç›®å½•åˆ—è¡¨</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#coding=utf_8</span>
from fabric.api import <span class="k">*</span>

env.hosts<span class="o">=[</span><span class="s1">'192.168.17.192'</span>, <span class="s1">'192.168.17.193'</span><span class="o">]</span>
<span class="c">#env.password='python'</span>
env.passwords <span class="o">=</span> <span class="o">{</span>
    <span class="s1">'itcast@192.168.17.192:22'</span>:<span class="s1">'python'</span>,
    <span class="s1">'itcast@192.168.17.193:22'</span>:<span class="s1">'python'</span>,
<span class="o">}</span>

@runs_once
def input_raw<span class="o">()</span>:
    <span class="k">return </span>prompt<span class="o">(</span><span class="s2">"please input directory name:"</span>, <span class="nv">default</span><span class="o">=</span><span class="s2">"/home"</span><span class="o">)</span>

def workask<span class="o">(</span><span class="nb">dirname</span><span class="o">)</span>:
    run<span class="o">(</span><span class="s1">'ls -l '</span> + <span class="nb">dirname</span><span class="o">)</span>

@task
def go<span class="o">()</span>:
    print<span class="o">(</span><span class="s1">'start ...'</span><span class="o">)</span>
    getdirname <span class="o">=</span> input_raw<span class="o">()</span>
    workask<span class="o">(</span>getdirname<span class="o">)</span>
    print<span class="o">(</span><span class="s1">'end ...'</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="ç¤ºä¾‹2ä¸Šä¼ æ–‡ä»¶å¹¶æ‰§è¡Œ">ç¤ºä¾‹2ï¼šä¸Šä¼ æ–‡ä»¶å¹¶æ‰§è¡Œ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding=utf_8
</span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="s">'itcast'</span>
<span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">'192.168.17.192'</span><span class="p">,</span> <span class="s">'192.168.17.193'</span><span class="p">]</span>
<span class="n">env</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s">'python'</span>

<span class="o">@</span><span class="n">task</span>
<span class="o">@</span><span class="n">runs_once</span>
<span class="k">def</span> <span class="nf">tar_task</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">lcd</span><span class="p">(</span><span class="s">'/home/itcast/testdemo'</span><span class="p">):</span>
        <span class="n">local</span><span class="p">(</span><span class="s">'tar zcvf demo.tar.gz demo.py'</span><span class="p">)</span>

<span class="o">@</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">put_task</span><span class="p">():</span>
    <span class="n">run</span><span class="p">(</span><span class="s">'mkdir -p /home/itcast/testdemo'</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'/home/itcast/testdemo'</span><span class="p">):</span>
        <span class="n">put</span><span class="p">(</span><span class="s">'/home/itcast/testdemo/demo.tar.gz'</span><span class="p">,</span> <span class="s">'/home/itcast/testdemo/demo.tar.gz'</span><span class="p">)</span>

<span class="o">@</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">check_task</span><span class="p">():</span>
    <span class="n">lmd5</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">'md5sum /home/itcast/testdemo/demo.tar.gz'</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rmd5</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">'md5sum /home/itcast/testdemo/demo.tar.gz'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lmd5</span> <span class="o">==</span> <span class="n">rmd5</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'OK ...'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'ERROR ...'</span><span class="p">)</span>

<span class="o">@</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">run_task</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'/home/itcast/testdemo'</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s">'tar zxvf demo.tar.gz'</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">'python demo.py'</span><span class="p">)</span>

<span class="o">@</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">go</span><span class="p">():</span>
    <span class="n">tar_task</span><span class="p">()</span>
    <span class="n">put_task</span><span class="p">()</span>
    <span class="n">check_task</span><span class="p">()</span>
    <span class="n">run_task</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="ä»£ç è‡ªåŠ¨åŒ–éƒ¨ç½²">ä»£ç è‡ªåŠ¨åŒ–éƒ¨ç½²</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#coding=utf_8
</span><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="s">'itcast'</span>
<span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">'192.168.17.192'</span><span class="p">,</span> <span class="s">'192.168.17.193'</span><span class="p">]</span>
<span class="n">env</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s">'python'</span>

<span class="o">@</span><span class="n">runs_once</span>
<span class="o">@</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">local_update</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">lcd</span><span class="p">(</span><span class="s">"/home/itcast/tmp/itcasthello"</span><span class="p">):</span>
        <span class="n">local</span><span class="p">(</span><span class="s">"git add -A"</span><span class="p">)</span>
        <span class="n">local</span><span class="p">(</span><span class="s">"git commit -m 'update'"</span><span class="p">)</span>
        <span class="n">local</span><span class="p">(</span><span class="s">"git pull origin master"</span><span class="p">)</span>
        <span class="n">local</span><span class="p">(</span><span class="s">"git push origin master"</span><span class="p">)</span>


<span class="o">@</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">remote_update</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">"/home/itcast/tmp/itcasthello"</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s">"git checkout master"</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">"git pull origin master"</span><span class="p">)</span>

<span class="o">@</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
    <span class="n">local_update</span><span class="p">()</span>
    <span class="n">remote_update</span><span class="p">()</span>
</code></pre></div></div>

:ET