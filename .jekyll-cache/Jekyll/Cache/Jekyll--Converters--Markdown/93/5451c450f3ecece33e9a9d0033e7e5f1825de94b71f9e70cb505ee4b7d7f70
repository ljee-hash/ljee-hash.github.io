I"ù<h1 id="apache-access-logä¸­çš„options-çš„å«ä¹‰">Apache Access Logä¸­çš„OPTIONS *çš„å«ä¹‰</h1>

<p>åœ¨Apacheçš„Access Logä¸­ä¼šçœ‹åˆ°å¾ˆå¤šå¦‚ä¸‹çš„è®¿é—®æ—¥å¿—ï¼š</p>

<pre class="prettyprint linenums prettyprinted" style="">
1.  127.0.0.1 - - [05/May/2011:10:54:07 +0800] "OPTIONS * HTTP/1.0" 200 -
2.  127.0.0.1 - - [05/May/2011:10:54:08 +0800] "OPTIONS * HTTP/1.0" 200 -
3.  127.0.0.1 - - [05/May/2011:10:54:09 +0800] "OPTIONS * HTTP/1.0" 200 -
4.  127.0.0.1 - - [05/May/2011:10:54:10 +0800] "OPTIONS * HTTP/1.0" 200 -
</pre>

<p>è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p>

<p>Apacheçš„æ–‡æ¡£ä¸­ï¼Œ æœ‰å¦‚ä¸‹çš„è¯´æ˜ï¼š</p>

<blockquote>
  <p>When the Apache HTTP Server manages its child processes, it needs a way to wake up processes that are listening for new connections. To do this, it sends a simple HTTP request back to itself. This request will appear in the access_log file with the remote address set to the loop-back interface (typically 127.0.0.1 or ::1 if IPv6 is configured). If you log the User-Agent string (as in the combined log format), you will see the server signature followed by â€œ(internal dummy connection)â€ on non-SSL servers. During certain periods you may see up to one such request for each httpd child process.</p>
</blockquote>

<p>å¯æ˜¯ï¼Œä¸ºä»€ä¹ˆè¦å”¤é†’å‘¢ï¼Ÿ å”¤é†’æ˜¯ä¸ºäº†åšä»€ä¹ˆå‘¢ï¼Ÿ</p>

<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201411/09/162942xy7laaym1h0myq9z.jpg" alt="" /></p>

<p>åœ¨Apache Preforkæ¨¡å¼ä¸‹ï¼Œ å¯åŠ¨çš„æ—¶å€™ï¼ŒApacheå°±ä¼šforkå‡ºä¸€äº›workerè¿›ç¨‹ï¼Œ æ¥å‡†å¤‡æ¥å—è¯·æ±‚ï¼Œ è¿™äº›workerè¿›ç¨‹ï¼Œåœ¨å®Œæˆå‡†å¤‡å·¥ä½œä»¥åï¼Œ å°±ä¼šè¿›å…¥blockæ¨¡å¼çš„ç›‘å¬æ²‰ç¡ä¸­ï¼Œ ç­‰å¾…è¯·æ±‚åˆ°æ¥è€Œè¢«å”¤é†’ã€‚</p>

<p>å¦å¤–ä¸€æ–¹é¢ï¼Œ åœ¨Preforkæ¨¡å¼ä¸‹ï¼Œ å½“è¯·æ±‚å¾ˆå¤šï¼Œ ç›®å‰çš„workerè¿›ç¨‹æ•°ä¸å¤Ÿå¤„ç†çš„æ—¶å€™ï¼Œ å°±ä¼šé¢å¤–å†forkä¸€äº›workerè¿›ç¨‹å‡ºæ¥ï¼Œ ä»¥æ»¡è¶³å½“å‰çš„è¯·æ±‚ã€‚</p>

<p>è€Œåœ¨è¿™äº›è¯·æ±‚é«˜å³°è¿‡åï¼Œ å¦‚æœé¢å¤–forkå‡ºæ¥çš„è¿›ç¨‹æ•°å¤§äºäº†MaxSpareServersï¼Œ Apacheå°±ä¼šå‘Šè¯‰è¿™äº›workerè¿›ç¨‹é€€å‡ºï¼Œ é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ã€‚</p>

<p>è¿™äº›è¿›ç¨‹éƒ½åœ¨æ²‰ç¡ä¸­å•Šï¼Œ æ€ä¹ˆå‘Šè¯‰ä»–ä»¬ï¼Œ å¹¶ä¸”è®©ä»–ä»¬è‡ªæˆ‘é€€å‡ºå‘¢ï¼Ÿ</p>

<p>Apacheä¼šé¦–å…ˆå‘é€ä¸€ä¸ªé€€å‡ºçŠ¶æ€å­—(GRACEFUL_CHAR !)ç»™è¿™äº›Workè¿›ç¨‹ï¼š</p>

<pre class="prettyprint linenums prettyprinted" style="">
1.  static apr_status_t pod_signal_internal(ap_pod_t \*pod)
2.  {
3.      apr_status_t rv;
4.      char char_of_death = '!';
5.      apr_size_t one = 1;
6.
7.      rv = apr_file_write(pod-&gt;pod_out, &amp;char_of_death, &amp;one);
8.      if (rv != APR_SUCCESS) {
9.          ap_log_error(APLOG_MARK, APLOG_WARNING, rv, ap_server_conf,
10.                       "write pipe_of_death");
11.      }
12.
13.      return rv;
14.  }
</pre>

<p>ä½†æ­¤æ—¶ï¼Œ Workerè¿›ç¨‹ä¸ä¼šå»è¯»è¿™äº›çŠ¶æ€å­—ï¼Œ å› ä¸ºä»–ä»¬è¿˜åœ¨æ²‰ç¡ã€‚</p>

<p>è¿™ä¸ªæ—¶å€™Apacheå°±ä¼šå‘é€ä¸€ä¸ªOPTIONSè¯·æ±‚ç»™è‡ªå·±ï¼Œ å”¤é†’è¿™äº›æ²‰ç¡çš„è¿›ç¨‹ï¼š</p>

<pre class="prettyprint linenums prettyprinted" style="">
1.  static apr_status_t dummy_connection(ap_pod_t \*pod)
2.  {
3.  //...æœ‰çœç•¥
4.      /* Create the request string. We include a User-Agent so that
5.       \* adminstrators can track down the cause of the odd-looking
6.       \* requests in their logs.
7.       \*/
8.      srequest = apr_pstrcat(p, "OPTIONS * HTTP/1.0\r\nUser-Agent: ",
9.                             ap_get_server_banner(),
10.                             " (internal dummy connection)\r\n\r\n", NULL);
11.  //...æœ‰çœç•¥
12.  }
</pre>

<p>è¿™äº›è¿›ç¨‹åœ¨å¤„ç†å®Œå½“å‰è¯·æ±‚ä»¥å(OPTIONSè¯·æ±‚)ï¼Œ å°±ä¼šå‘ç°ï¼Œ ohï¼Œ ä¸»è¿›ç¨‹è®©æˆ‘é€€å‡ºã€‚</p>

<pre class="prettyprint linenums prettyprinted" style="">
1.  static void child_main(int child_num_arg)
2.  {
3.  //...æœ‰çœç•¥
4.
5.      while (!die_now &amp;&amp; !shutdown_pending) {
6.  //...æœ‰çœç•¥
7.          //1. listen
8.          //2. accept
9.          //3. process request
10.
11.          /* Check the pod and the generation number after processing a
12.           \* connection so that we'll go away if a graceful restart occurred
13.           \* while we were processing the connection or we are the lucky
14.           \* idle server process that gets to die.
15.           \*/
16.          if (ap_mpm_pod_check(pod) == APR_SUCCESS) { /* selected as idle? */
17.              die_now = 1;
18.          }
19.  //...æœ‰çœç•¥
20.     }
21.  //...æœ‰çœç•¥
22.  }
</pre>

<p>äºæ˜¯ï¼Œ å®ƒå°±åšå®Œæ¸…ç†å·¥ä½œï¼Œ ç„¶åè‡ªæˆ‘æ¶ˆäº¡äº†~~~</p>

<h2 id="å¼•ç”¨å‚è€ƒ">å¼•ç”¨å‚è€ƒ</h2>

<blockquote>
  <p>https://linux.cn/article-4190-1.html</p>
</blockquote>
:ET